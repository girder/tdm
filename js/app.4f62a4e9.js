(function(t){function e(e){for(var i,r,o=e[0],c=e[1],l=e[2],u=0,d=[];u<o.length;u++)r=o[u],s[r]&&d.push(s[r][0]),s[r]=0;for(i in c)Object.prototype.hasOwnProperty.call(c,i)&&(t[i]=c[i]);h&&h(e);while(d.length)d.shift()();return n.push.apply(n,l||[]),a()}function a(){for(var t,e=0;e<n.length;e++){for(var a=n[e],i=!0,o=1;o<a.length;o++){var c=a[o];0!==s[c]&&(i=!1)}i&&(n.splice(e--,1),t=r(r.s=a[0]))}return t}var i={},s={app:0},n=[];function r(e){if(i[e])return i[e].exports;var a=i[e]={i:e,l:!1,exports:{}};return t[e].call(a.exports,a,a.exports,r),a.l=!0,a.exports}r.m=t,r.c=i,r.d=function(t,e,a){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:a})},r.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"===typeof t&&t&&t.__esModule)return t;var a=Object.create(null);if(r.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)r.d(a,i,function(e){return t[e]}.bind(null,i));return a},r.n=function(t){var e=t&&t.__esModule?function(){return t["default"]}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="/tdm/";var o=window["webpackJsonp"]=window["webpackJsonp"]||[],c=o.push.bind(o);o.push=e,o=o.slice();for(var l=0;l<o.length;l++)e(o[l]);var h=c;n.push(["ff75","chunk-vendors"]),a()})({"286b":function(t,e,a){},"4ee8":function(t,e,a){"use strict";var i=a("286b"),s=a.n(i);s.a},"67d3":function(t,e,a){},6929:function(t,e,a){"use strict";var i=a("b91b"),s=a.n(i);s.a},"6ab1":function(t,e,a){"use strict";var i=a("67d3"),s=a.n(i);s.a},b1e1:function(t,e,a){},b91b:function(t,e,a){},e802:function(t,e,a){"use strict";var i=a("b1e1"),s=a.n(i);s.a},ff75:function(t,e,a){"use strict";a.r(e);a("cadf"),a("551c"),a("097d");var i=a("2b0e"),s=a("ce5b"),n=a.n(s),r=a("9437"),o=a.n(r),c=(a("d1e7"),a("bf40"),function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",[a("p",{staticClass:"title"},[t._v("Features:")]),t._m(0),a("v-layout",{staticClass:"pb-3",attrs:{column:""}},[a("label",[t._v("Activities:")]),a("input",{ref:"activities",attrs:{type:"file",accept:".yml"}}),a("label",{staticClass:"mt-2"},[t._v("Geometry:")]),a("input",{ref:"geometry",attrs:{type:"file",accept:".yml"}}),a("label",{staticClass:"mt-2"},[t._v("Types:")]),a("input",{ref:"types",attrs:{type:"file",accept:".yml"}})]),a("v-btn",{staticClass:"ma-0",attrs:{width:"80px",color:"primary"},on:{click:t.process}},[t._v("Process KPF")])],1)}),l=[function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ul",{staticClass:"pb-3"},[a("li",[t._v("click-and-drag to zoom")]),a("li",[t._v("click elsewhere on the video to dismiss")]),a("li",[t._v("click a row in the track table to scrub to that time")]),a("li",[t._v("toggle annotation labels with the switch")]),a("li",[t._v("change color scheme with the dropdown")]),a("li",[t._v("upload your own KPF YML files")])])}],h=a("795b"),u=a.n(h),d=(a("96cf"),a("3b8d")),f=(a("5df3"),a("768b")),p=a("75fc"),m=(a("55dd"),a("7f7f"),a("5176")),v=a.n(m),y=a("bd86"),g=a("59ad"),b=a.n(g),w=(a("28a5"),a("cebc")),k=a("a4bb"),x=a.n(k),T=(a("ac6a"),a("d225")),S=a("b0b4"),C=a("651e"),_=a.n(C),E={ACTIVE:"active",DISABLED:"disabled",HIDDEN:"hidden"},O={POINT:1,LINE:2};function P(t,e,a){var i=a.frame-e.frame,s=Math.abs((t-e.frame)/i),n=1-s,r=e.box.map(function(t,i){return e.box[i]*n+a.box[i]*s}),o=Math.round(e.frame*n+a.frame*s);return Object(w["a"])({},e,{frame:o,box:r})}function j(t,e){return t.map(function(t){return t*e})}function A(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.5;return[Math.round(t[2]*e+t[0]*e),Math.round(t[3]*a+t[1]*a)]}function B(t,e,a){for(var i=[],s=null,n=!1,r=0;r<t.detections.length;r+=1){var o=t.detections[r],c=o.meta[a];c>e&&!n?(n=!0,s=[o.frame+.01]):c<e&&n?(n=!1,s.push(o.frame),i.push(s)):n&&r===t.detections.length-1&&(n=!1,s.push(o.frame),i.push(s))}return i}function $(t,e,a){return t.map(function(t){return B(t,e,a)}).filter(function(t){return t.length>0})}function I(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.5;return t.slice(0,t.length-1).map(function(i,s){return{type:O.LINE,data:{width:2,a:A(t[s].box,e,a),b:A(t[s+1].box,e,a)}}})}var F="id1",M="tsr0",R=function(t,e){var a=new FileReader;return new u.a(function(i,s){a.onerror=function(t){console.error(t),a.abort(),s(new DOMException("Problem parsing input file."))},a.onload=function(){i(a.result)};try{a.readAsText(t)}catch(n){if(!e)throw n;i(e)}})},D=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};Object(T["a"])(this,t),this.activities=e,this.geom=a,this.types=i,this.tracksByActor={},this.meta=s,this.postProcess()}return Object(S["a"])(t,[{key:"postProcess",value:function(){var e=this;this.geom=t.filterEmpty(this.geom,[F,"g0","ts0"]),this.activities=t.filterEmpty(this.activities,["act2"]),this.types=t.filterEmpty(this.types,[F]);var a={};this.types.forEach(function(t){a[t[F]]={id:t.id,type:x()(t.cset3)[0]||"Unknown"}}),this.types=a,this.geom=this.geom.map(function(t){return Object(w["a"])({},t,Object(y["a"])({bbox:t.bbox||t.g0.split(" ").map(function(t){return b()(t)}),ts0:t.ts0||t.frame},F,t[F]||0))}),this.geom.forEach(function(t){var a=t[F];a in e.tracksByActor?e.tracksByActor[a].push(t):e.tracksByActor[a]=[t]}),this.activities=this.activities.map(function(a){return Object(w["a"])({},a,{actors:a.actors.map(function(a){return Object(w["a"])({},a,{timespan:a.timespan[0][M],detections:t.filterRange(e.tracksByActor[a[F]],"ts0",a.timespan[0][M][0],a.timespan[0][M][1]),type:e.types[a[F]]?e.types[a[F]].type:"Unknown"})}),name:a.act2?x()(a.act2)[0]:a.src})})}},{key:"getTDM",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"track";return this.tracks.map(function(i,s){var n=v()(Object(w["a"])({},t.meta,{name:i.activity.name,activity_id:i.activity.id2,type:i.actor.type,id:i.activity.id,actor_id:i.actor[F],src_status:i.activity.src_status||"unset"}),e),r={meta:n,key:"".concat(a).concat(s),interpolated:i.detections.length<i.timespan[1]-i.timespan[0],color:"green",state:E.ACTIVE,begin:i.timespan[0],end:i.timespan[1]},o=i.detections.map(function(t,e){return{frame:t.frame||t.ts0,meta:{src:t.src,occlusion:t.occlusion,confidence:0===e||e===i.detections.length-1?.001:1},box:t.bbox,track:r}}).sort(function(t,e){return t.frame-e.frame});return r.detections=o,r})}},{key:"tracks",get:function(){var t;return(t=[]).concat.apply(t,Object(p["a"])(this.activities.map(function(t){return t.actors.map(function(e){return{activity:t,actor:e,timespan:e.timespan,detections:e.detections,actorColor:e.randomColor}})}))).sort(function(t,e){return t.detections[0].ts1-e.detections[0].ts1})}}],[{key:"filterEmpty",value:function(t,e){return t.filter(function(t){return e.some(function(e){return e in t})})}},{key:"filterRange",value:function(t,e,a,i){return t.filter(function(t){return t[e]<=i&&t[e]>=a})}},{key:"fromText",value:function(e,a,i){var s=_.a.safeLoad(e).map(function(t){return Object(w["a"])({},t.act)}),n=_.a.safeLoad(a).map(function(t){return Object(w["a"])({},t.geom)}),r=_.a.safeLoad(i).map(function(t){return Object(w["a"])({},t.types)});return new t(s,n,r)}},{key:"fromFiles",value:function(){var e=Object(d["a"])(regeneratorRuntime.mark(function e(a,i,s){var n,r,o,c,l,h;return regeneratorRuntime.wrap(function(e){while(1)switch(e.prev=e.next){case 0:return n=[R(a),R(i),R(s,"- {}")],e.next=3,u.a.all(n);case 3:return r=e.sent,o=Object(f["a"])(r,3),c=o[0],l=o[1],h=o[2],e.abrupt("return",t.fromText(c,l,h));case 9:case"end":return e.stop()}},e,this)}));function a(t,a,i){return e.apply(this,arguments)}return a}()}]),t}(),L={methods:{process:function(){var t=Object(d["a"])(regeneratorRuntime.mark(function t(){var e,a,i,s;return regeneratorRuntime.wrap(function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,new u.a(function(t){return window.setTimeout(t,100)});case 2:if(e=this.$refs.activities.files,a=this.$refs.geometry.files,i=this.$refs.types.files,!e.length||!a.length){t.next=10;break}return t.next=8,D.fromFiles(e[0],a[0],i[0]);case 8:s=t.sent,this.$emit("loaded",s.getTDM({origin:"Import"},"itrack"));case 10:case"end":return t.stop()}},t,this)}));function e(){return t.apply(this,arguments)}return e}()}},W=L,N=a("2877"),z=Object(N["a"])(W,c,l,!1,null,null,null),V=z.exports,H=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("v-layout",{attrs:{column:""}},[a("v-checkbox",{staticClass:"ma-0 pa-0",attrs:{"hide-details":"","input-value":t.allchecked,color:"secondary"},on:{change:t.toggle}}),t._l(t.statemap,function(e,i){return a("v-flex",{key:i},[a("v-checkbox",{staticClass:"ma-0 pa-0",attrs:{"hide-details":"","input-value":e===t.STATES.ACTIVE,color:t.colormap[i]},on:{change:function(a){t.updateState(i,e)}}})],1)})],2)},G=[],K=a("2f62"),U={data:function(){return{checked:[],allchecked:!0,STATES:E}},computed:Object(K["d"])({statemap:"statemap",colormap:"colormap"}),methods:Object(w["a"])({},Object(K["c"])(["resetState","toggleByMeta"]),{toggle:function(){this.allchecked?this.resetState({newstate:E.DISABLED}):this.resetState({newstate:E.ACTIVE}),this.allchecked=!this.allchecked},updateState:function(t,e){var a=e===E.DISABLED?E.ACTIVE:E.DISABLED;this.toggleByMeta({value:t,newState:a})}})},q=U,Y=Object(N["a"])(q,H,G,!1,null,null,null),X=Y.exports,J=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("v-data-table",{staticClass:"small-table",attrs:{items:t.tracks,headers:t.headers,"rows-per-page-items":t.rowsPerPage},scopedSlots:t._u([{key:"items",fn:function(e){return[e.item.state===t.STATES.ACTIVE?a("tr",{on:{click:function(a){t.$emit("click",e.item)}}},[t._l(t.meta,function(i,s){return a("td",{key:i},[t._v(t._s(e.item.meta[s]))])}),a("td",[t._v("["+t._s(e.item.begin)+", "+t._s(e.item.end)+"]")]),a("td",[a("v-icon",{style:{color:e.item.color}},[t._v("brightness_1")])],1)],2):t._e()]}}])})},Q=[],Z={props:{meta:{type:Object,default:function(){}}},data:function(){var t,e=this;return{STATES:E,rowsPerPage:[15,25],headers:(t=[]).concat.apply(t,Object(p["a"])(x()(this.meta).map(function(t){return{text:e.meta[t],value:"meta.".concat(t),width:"1%"}})).concat([{text:"Range",value:"begin"},{text:"Color",value:"color",width:"1%"}]))}},computed:Object(K["d"])({tracks:function(t){return t.tracks.filter(function(t){return t.state===E.ACTIVE})}})},tt=Z,et=(a("6ab1"),Object(N["a"])(tt,J,Q,!1,null,null,null)),at=et.exports,it=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"tdmtemporal py-2"},[a("v-layout",{ref:"container",attrs:{row:""}},[a("selection-widget",{staticClass:"shrink mx-2 my-0"}),a("div",{staticClass:"tdmtemporalGraph grow"},[a("time-slider",{staticStyle:{width:"100%"}}),a("div",{ref:"svgcontainer",staticClass:"wrapper",staticStyle:{width:"100%"}},[a("svg",{ref:"barsvg",attrs:{width:t.width,height:t.height},on:{mousemove:function(t){}}},[t._l(t.groups,function(e){return a("g",{style:{transform:"translate(0px, "+e.top+"px)"}},[t._l(e.paths,function(t){return a("path",{staticClass:"bar",attrs:{d:t.d,stroke:t.stroke,opacity:t.opacity}})}),a("text",{staticClass:"bar",attrs:{x:e.text.x,y:e.text.y,dy:e.text.dy,stroke:e.text.stroke}},[t._v(t._s(e.text.text))])],2)}),a("path",{attrs:{d:t.timeline.d,stroke:t.timeline.stroke}})],2)])],1)],1),"number"===typeof t.threshold&&t.tracks.length?a("v-layout",{attrs:{row:"","justify-end":""}},[a("svg",{attrs:{width:t.width,height:t.thresholdHeight},on:{click:t.handleThreshClick}},[a("path",{attrs:{d:t.timeline.d,stroke:t.timeline.stroke}}),a("g",{style:{transform:"translate(0px, "+t.margin+"px)"}},[a("rect",{attrs:{x:t.waterline.x,y:t.waterline.y,width:t.waterline.width,height:t.waterline.height,stroke:t.waterline.stroke,fill:t.waterline.stroke,opacity:t.waterline.opacity}}),t._l(t.threshPaths,function(t){return a("path",{staticClass:"thresh",attrs:{d:t.d,stroke:t.stroke,opacity:t.opacity}})}),a("text",{staticClass:"bar",attrs:{x:t.threshtext.x,y:t.threshtext.y,dy:t.threshtext.dy,stroke:t.threshtext.stroke}},[t._v("thresh: "+t._s(t.threshtext.text))])],2)])]):t._e()],1)},st=[],nt=(a("c5f6"),a("5698")),rt=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("input",{staticClass:"slider py-1",attrs:{type:"range",max:t.duration,step:t.step},domProps:{value:t.time-t.offset},on:{input:t.progressChangeInput}})},ot=[],ct=new i["default"],lt=ct,ht={data:function(){return{time:0}},mounted:function(){var t=this;lt.$on("active",function(e){return t.time=e}),lt.$on("passive",function(e){return t.time=e})},computed:Object(w["a"])({},Object(K["d"])({duration:"duration",framerate:"framerate",offset:"offset"}),{step:function(){return 1/this.framerate}}),methods:{progressChangeInput:function(t){var e=b()(t.target.value),a=b()(e.toFixed(3));lt.$emit("active",a+this.offset)}}},ut=ht,dt=Object(N["a"])(ut,rt,ot,!1,null,null,null),ft=dt.exports,pt=(a("386d"),a("bfb3")),mt=a.n(pt),vt=void 0,yt=arguments,gt=function(t,e){var a,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:NaN,n=s;return function(){var r=vt,o=yt,c=i||0===n,l=function(){a=null,n=s,c||t.apply(r,o)};clearTimeout(a),c?(n=s,t.apply(r,o)):(mt()(n)||(n-=1),a=setTimeout(l,e))}};function bt(t,e,a){return Math.min(a,Math.max(e,t))}function wt(t){var e={},a=document.createElement("a");a.href=t;for(var i=a.search.substring(1),s=i.split("&"),n=0;n<s.length;n+=1){var r=s[n].split("=");e[r[0]]=decodeURIComponent(r[1])}return e}var kt={components:{TimeSlider:ft,SelectionWidget:X},props:{thresholdHeight:{type:Number,default:150},thresholdKey:{type:String,default:"confidence"},threshold:{type:Number,default:null},margin:{type:Number,default:10}},data:function(){return{xbuffer:2,stroke:36,width:100,time:0,groups:[],threshPaths:[],height:100,series:[],timeline:{},waterline:{},threshtext:{},drag:!1}},mounted:function(){var t=this;lt.$on("active",function(e){return t.time=e-t.offset}),lt.$on("passive",function(e){return t.time=e-t.offset}),window.addEventListener("resize",this.handleResize),this.handleResize();var e=this.$refs.barsvg;e.addEventListener("mousedown",this.listen),e.addEventListener("mouseup",this.ignore),e.addEventListener("mouseleave",this.ignore)},beforeDestroy:function(){window.removeEventListener("resize",this.handleResize)},computed:Object(w["a"])({},Object(K["d"])(["cache","colormap","statemap","offset","duration","framerate","tracks","colorBy"])),watch:{colormap:function(){this.setSeries(),this.setThreshPaths(),this.setThreshText()},statemap:function(){this.setGroups(),this.setThreshPaths()},time:function(){this.setTimeline()},series:function(){this.setGroups(),this.setHeight()},width:function(){this.setHeight(),this.setTimeline(),this.setWaterline(),this.setGroups(),this.setThreshPaths(),this.setThreshText()},duration:function(){this.setGroups(),this.setThreshPaths(),this.setTimeline()},framerate:function(){this.setGroups(),this.setThreshPaths()},threshold:function(){this.setWaterline(),this.setSeries(),this.setThreshText()}},methods:{handleResize:function(){var t=this;this.$nextTick(function(){var e=t.$refs.container.clientWidth;t.width=t.$refs.svgcontainer.clientWidth,t.width>e&&(t.width=e-50)})},handleThreshClick:function(t){var e=nt["b"]().domain([0,this.thresholdHeight-2*this.margin]).range([1,0]);this.$emit("update:threshold",b()(bt(e(t.offsetY-this.margin),0,1).toPrecision(4)))},setGroups:function(){var t=this,e=nt["b"]().domain([0,this.duration*this.framerate]).range([0,this.width]),a=nt["a"]().defined(function(t){return t}).x(function(t){return e(t)}).y(function(t){return 0});this.groups=this.series.map(function(e,i){var s,n=t.xbuffer+t.stroke/2+(t.stroke+t.xbuffer)*i,r=(s=[]).concat.apply(s,Object(p["a"])(e.data.map(function(i){return i.map(function(i){return{d:a(i),stroke:t.statemap[e.key]===E.ACTIVE?e.color:"#ccc",opacity:.4}})})));return r.push({d:a([.01,t.duration*t.framerate]),stroke:"#ccc",opacity:.2}),{text:{x:10,y:0,dy:".35em",text:e.key,stroke:"#555"},top:n,paths:r}})},setThreshPaths:function(){var t=this,e=nt["b"]().domain([0,this.duration*this.framerate]).range([0,this.width]),a=nt["b"]().domain([0,1]).range([this.thresholdHeight-2*this.margin,0]),i=nt["a"]().x(function(t){return e(t.frame)}).y(function(e){return a(e.meta[t.thresholdKey]||NaN)});this.threshPaths=this.tracks.map(function(e){return{d:i(e.detections),stroke:t.statemap[e.meta[t.colorBy]]===E.ACTIVE?e.color:"#ccc",opacity:.5}})},setHeight:function(){this.height=(this.stroke+this.xbuffer)*this.series.length},setSeries:function(){var t=this;this.series=x()(this.colormap).map(function(e){var a;return a=t.threshold?$(t.cache[e],t.threshold,t.thresholdKey):t.cache[e].map(function(t){return[[t.begin+.01,t.end]]}),{key:e,data:a,color:t.colormap[e]}})},setTimeline:function(){var t=nt["b"]().domain([0,this.duration]).range([0,this.width]),e=nt["a"]().x(function(e){return t(e[0])}).y(function(t){return t[1]});this.timeline={d:e([[this.time,0],[this.time,this.height+100]]),stroke:"#000"}},setWaterline:function(){var t=nt["b"]().domain([0,1]).range([this.thresholdHeight-2*this.margin,0]);this.waterline={x:0,y:t(this.threshold),width:this.width,height:t(1-this.threshold),stroke:"#fdbf6f",opacity:.3}},setThreshText:function(){this.threshtext={x:10,y:0,dy:".35em",text:String(this.threshold),stroke:"#FFF"}}}},xt=kt,Tt=(a("e802"),Object(N["a"])(xt,it,st,!1,null,"206935fb",null)),St=Tt.exports,Ct=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"video-region"},[a("v-layout",{staticClass:"relative",attrs:{column:"","align-center":""}},[a("canvas",{ref:"staticcanvas",staticClass:"static-canvas"}),a("canvas",{ref:"canvas",staticClass:"canvas"}),a("canvas",{ref:"pipcanvas",staticClass:"pip-canvas"}),a("canvas",{ref:"pipstatic",staticClass:"pip-static-canvas"}),a("video",{ref:"video",attrs:{muted:"",width:t.width,height:t.width/t.videoWidth*t.videoHeight},domProps:{muted:!0},on:{canplay:t.canPlay}},[a("source",{attrs:{src:t.url},on:{error:function(e){t.$emit("error",e)}}}),a("h1",[t._v("Could not load video.")])])])],1)},_t=[],Et=(a("6b54"),a("6c7b"),50),Ot=["#6A5ACD","#00FF00","#FF00FF","#FFFF00","#FF0000","#00FFFF","#FF69B4"],Pt=["#543005","#8c510a","#bf812d","#dfc27d","#f6e8c3","#c7eae5","#80cdc1","#35978f","#01665e","#003c30"],jt="#a0a0a0",At={props:{width:{type:Number,required:!0},zoom:{type:Number,default:0},labelFormat:{type:Array,default:function(){return["label"]}},defaultColor:{type:String,default:"yellow"},pipsize:{type:Number,default:.4},loading:{type:Boolean,default:!1},lineWidth:{type:Number,default:4}},data:function(){return{ctx:null,pipctx:null,staticctx:null,pipstaticctx:null,mouse:{},video:null,animationId:null,debouncedRedraw:function(){},debounceTime:function(){}}},computed:Object(w["a"])({},Object(K["d"])(["url","framerate","duration","offset","playbackRate","labels","shapes","playing","tracks"]),Object(K["d"])({videoWidth:"width",videoHeight:"height"})),watch:{playbackRate:function(t){this.$refs.video.playbackRate=t},tracks:function(){this.updateActive(this.$refs.video.currentTime*this.framerate),this.staticctx&&this.updateStatic()},width:function(){this.ctx&&this.pipctx&&this.staticctx&&this.pipstaticctx&&(this.setupCanvas(this.ctx),this.setupCanvas(this.staticctx),this.setupPip(this.pipctx),this.setupPip(this.pipstaticctx),this.updateStatic(),this.resetMouse(),this.url||this.drawInfo(this.ctx,"Source Unavailable"))},playing:function(t){var e=this.$refs.video;t?e.play():e.pause()},shapes:function(t){this.updateStatic()},url:function(t){this.$refs.video.load()}},beforeDestroy:function(){window.removeEventListener("mouseup",this.mouseup,!1),lt.$off("active",this.updateTime)},mounted:function(){var t=this;this.stills=[],this.ctx=this.$refs.canvas.getContext("2d"),this.pipctx=this.$refs.pipcanvas.getContext("2d"),this.staticctx=this.$refs.staticcanvas.getContext("2d"),this.pipstaticctx=this.$refs.pipstatic.getContext("2d"),this.debouncedRedraw=gt(function(){t.clearCanvas(t.pipstaticctx),t.drawPiP(t.pipstaticctx,t.tracks,t.drawStatic)},100);var e=function(){return lt.$emit("passive",t.$refs.video.currentTime)};this.debounceTime=gt(e,8e3,!1,1),lt.$on("active",this.updateTime),this.video=this.$refs.video,this.setupCanvas(this.ctx),this.setupCanvas(this.staticctx),this.setupPip(this.pipctx),this.setupPip(this.pipstaticctx),this.resetMouse(),this.$refs.canvas.addEventListener("mousedown",this.mousedown,!1),window.addEventListener("mouseup",this.mouseup,!1),this.$refs.canvas.addEventListener("mousemove",this.mousemove,!1),this.$refs.canvas.addEventListener("mousewheel",this.scrollmove),this.updateStatic(),this.drawInfo(this.ctx,"Source Unavailable.")},methods:Object(w["a"])({},Object(K["c"])(["setPlaying"]),{updateTime:function(t){this.$refs.video.currentTime=t,this.updateActive(t*this.framerate)},updateActive:function(t){var e=this.$store.getters.activeKeyFrames(t),a=this.$store.getters.activeContinuousFrames(t);this.stills=a.concat(e)},updateStatic:function(){this.clearCanvas(this.staticctx),this.drawStatic(this.staticctx,this.tracks,0,0,this.videoWidth),this.debouncedRedraw()},loop:function(){var t=this.video,e=this.offset,a=this.duration,i=t.currentTime*this.framerate,s=e*this.framerate;i<s&&(t.currentTime=e),t.paused||t.ended?(t.ended||t.currentTime>e+a)&&(this.setPlaying({playing:!1}),lt.$emit("active",e)):(this.debounceTime(),this.updateActive(i)),this.clearCanvas(this.ctx),this.clearCanvas(this.pipctx),this.loading?this.drawInfo(this.ctx,"LOADING..."):(this.drawStills(this.ctx,this.stills,0,0,this.videoWidth),this.drawStamp(i),this.drawMouse(),this.drawPiP(this.pipctx,this.stills,this.drawPiPDynamic)),window.requestAnimationFrame(this.loop)},setupCanvas:function(t){var e=t,a=this.width/this.videoWidth,i=a*this.videoHeight;e.canvas.width=this.width,e.canvas.height=i},setupPip:function(t){var e=t,a=e.canvas;e.canvas.width=this.width*this.pipsize,e.canvas.height=this.width*this.pipsize,a.style.paddingTop=150,a.style.paddingLeft=20},clearCanvas:function(t){t.clearRect(0,0,t.canvas.width,t.canvas.height)},drawInfo:function(t,e){var a=t;a.fillStyle="black",a.globalAlpha=.8,a.fillRect(0,0,a.canvas.width,a.canvas.height),a.globalAlpha=1,a.fillStyle="white",a.font="50px mono";var i=a.measureText(e).width;a.fillText(e,a.canvas.width/2-i/2,a.canvas.height/2-25)},drawDot:function(t,e,a,i,s,n){var r,o=t;n?(o.lineWidth=2,o.globalAlpha=.5,r=s):(o.lineWidth=1,o.globalAlpha=.2,r=jt,i=1),o.strokeStyle=r,o.fillStyle=r,o.beginPath(),o.arc(e,a,i,0,2*Math.PI),o.stroke(),o.fill(),o.globalAlpha=1},drawLine:function(t,e,a,i,s,n){var r,o=t;n?(o.lineWidth=2,o.globalAlpha=.6,r=s):(o.lineWidth=1,o.globalAlpha=.2,r=jt),o.strokeStyle=r,o.beginPath(),o.moveTo(e[0],e[1]),o.lineTo(a[0],a[1]),o.stroke(),o.globalAlpha=1},drawStatic:function(t,e,a,i,s){var n=this;if(this.shapes){var r=t,o=r.canvas.width/s;e.forEach(function(t){t.state!==E.HIDDEN&&t.shapes&&t.shapes.forEach(function(e,s){var c=o*a,l=o*i;switch(e.type){case O.POINT:var h=j(e.data.point,o);n.drawDot(r,h[0]-c,h[1]-l,e.data.radius,t.color,t.state===E.ACTIVE);break;case O.LINE:var u=j(e.data.a,o),d=j(e.data.b,o);n.drawLine(r,[u[0]-c,u[1]-l],[d[0]-c,d[1]-l],e.data.width,t.color,t.state===E.ACTIVE);break}})})}},drawStills:function(t,e,a,i,s){var n=this,r=t,o=r.canvas.width/s;e.forEach(function(t){if(t.box&&t.track.state!==E.HIDDEN){var e=j(t.box,o);r.beginPath(),r.lineWidth=t.track.state===E.ACTIVE?n.lineWidth:1;var s=t.track.state===E.ACTIVE?t.track.color||n.defaultColor:jt;r.strokeStyle=s,r.fillStyle=s;var c=o*a,l=o*i;if(r.rect(e[0]-c,e[1]-l,e[2]-e[0],e[3]-e[1]),r.stroke(),n.shapes){var h=A(e);n.drawDot(r,h[0]-c,h[1]-l,3,t.track.color,t.track.state===E.ACTIVE)}if(n.labels&&t.track.state===E.ACTIVE){var u=n.labelFormat.map(function(e){return t.track.meta[e]}),d=u.join(":");r.font="14px mono";var f=r.measureText(d).width;r.fillRect(e[0]-2-c,e[1]-12-l,f+4,14),r.fillStyle="black",r.fillText(d,e[0]-c,e[1]-l)}}})},drawStamp:function(t){var e=this.ctx;e.fillStyle="black",e.font="14px mono";var a="FRAME ".concat(Math.floor(t).toString()),i=e.measureText(a).width;e.globalAlpha=.6,e.fillRect(0,0,i+8,24),e.globalAlpha=1,e.fillStyle="white",e.fillText(a,4,18)},drawPiPDynamic:function(t,e,a,i,s){var n=t,r=(n.canvas,this.pipsize*this.width);n.imageSmoothingEnabled=!1,n.drawImage(this.$refs.video,a,i,s,s,0,0,n.canvas.width,n.canvas.height),n.beginPath(),n.lineWidth="10",n.strokeStyle="white",n.rect(0,0,r,r),n.stroke(),this.drawStills(n,this.stills,a,i,s)},drawPiP:function(t,e,a){var i=t,s=i.canvas;if(this.mouse.width){var n=this.mouse.width,r=this.width/this.videoWidth,o=n/r,c=this.mouse.x/r,l=this.mouse.y/r;(c+o)/this.videoWidth>.5?(s.style.left="20px",s.style.right="initial"):(s.style.right="20px",s.style.left="initial"),a(i,e,c,l,o),s.style.zIndex=101}else s.style.zIndex=-1},drawMouse:function(){this.ctx.globalAlpha=.3,this.ctx.fillStyle="yellow",this.ctx.fillRect(this.mouse.x,this.mouse.y,this.mouse.width,this.mouse.height),this.ctx.globalAlpha=1},canPlay:function(){this.playing&&this.$refs.video.play(),this.animationId||(this.animationId=window.requestAnimationFrame(this.loop)),this.$emit("init")},resetMouse:function(){this.mouse={x:0,y:0,width:0,height:0,drag:!1},this.debouncedRedraw()},mousedown:function(t){this.resetMouse(),this.mouse.x=t.layerX,this.mouse.oldx=t.layerX,this.mouse.y=t.layerY,this.mouse.oldy=t.layerY,this.mouse.drag=!0},mouseup:function(){this.mouse.drag=!1},mousemove:function(t){this.mouse.drag&&(this.mouse.width=t.layerX-this.mouse.oldx,this.mouse.height=this.mouse.width,this.debouncedRedraw())}})},Bt=At,$t=(a("4ee8"),Object(N["a"])(Bt,Ct,_t,!1,null,"55125edc",null)),It=$t.exports;function Ft(t){t.use(n.a),t.use(o.a)}var Mt=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("v-app",{staticClass:"annotation-view",attrs:{dark:""}},[a("v-flex",{attrs:{row:"",shrink:""}},[a("v-alert",{attrs:{value:t.loading,type:"warning"}},[t._v("Loading...")]),a("v-alert",{attrs:{value:t.err,type:"error"}},[t._v(t._s(t.err))])],1),a("tdm-app",{attrs:{autoplay:!1,loading:t.loading,"label-format":t.labelFormat,meta:t.meta}},[a("v-card",{attrs:{slot:"subvideowidget",dark:"",tile:""},slot:"subvideowidget"},[a("tdm-temporal",{staticClass:"mx-2",attrs:{threshold:t.threshold},on:{"update:threshold":function(e){t.threshold=e}}})],1),a("v-card",{staticClass:"my-2 pa-3",attrs:{slot:"widget"},slot:"widget"},[a("h3",{staticClass:"headline"},[t._v("Upload your own KPF")]),a("diva-kpf-widget",{on:{loaded:function(e){t.addTracks({tracks:e,key:t.colorBy})}}})],1)],1)],1)},Rt=[],Dt=a("e814"),Lt=a.n(Dt),Wt=a("bc3a"),Nt=a.n(Wt),zt=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"track-app"},[a("v-container",{attrs:{fluid:""}},[a("v-layout",{ref:"container",attrs:{row:"",wrap:"","justify-center":""}},[a("v-flex",{staticClass:"mb-2"},[a("v-layout",{staticClass:"mb-2",attrs:{column:"","align-center":""}},[a("v-flex",{style:{width:t.width+"px"},attrs:{shrink:""}},[t._t("title"),a("video-region",{ref:"region",attrs:{width:t.width,"label-format":t.labelFormat,"line-width":3,loading:t.loading||t.loadingInternal},on:{init:function(e){t.$emit("init")}}}),a("video-controls",{attrs:{"color-by-options":t.meta},on:{skip:function(e){t.$refs.region.skip(e)}}}),t._t("subvideowidget")],2)],1)],1),a("v-flex",{style:{width:t.twoColumn?t.sidebarWidth+"px":null}},[a("v-card",{staticClass:"mb-2"},[a("tdm-table",{attrs:{meta:t.meta},on:{click:t.handleTrackSelect}})],1),t._t("widget")],2)],1)],1)],1)},Vt=[],Ht=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("v-toolbar",{staticClass:"video-controls",attrs:{shift:"",dense:""}},[a("v-layout",{attrs:{row:"","align-center":"",wrap:""}},[a("v-flex",{attrs:{shrink:""}},[a("v-btn",{attrs:{icon:""},on:{click:function(e){t.skip(!1)}}},[a("v-icon",[t._v("skip_previous")])],1),a("v-btn",{attrs:{icon:""},on:{click:function(e){t.setPlaying({playing:!t.localPlaying})}}},[a("v-icon",{directives:[{name:"show",rawName:"v-show",value:t.localPlaying,expression:"localPlaying"}]},[t._v("pause")]),a("v-icon",{directives:[{name:"show",rawName:"v-show",value:!t.localPlaying,expression:"!localPlaying"}]},[t._v("play_arrow")])],1),a("v-btn",{attrs:{icon:""},on:{click:function(e){t.skip(!0)}}},[a("v-icon",[t._v("skip_next")])],1)],1),a("v-flex",{staticClass:"shrink"},[a("v-select",{staticClass:"px-2",attrs:{items:t.playbackRateOptions,value:t.localPlaybackRate,solo:""},on:{change:function(e){t.setPlaybackRate({playbackRate:e})}},scopedSlots:t._u([{key:"item",fn:function(e){return[a("p",[t._v(t._s(e.item+"x Speed"))])]}},{key:"selection",fn:function(e){return[a("span",[t._v(t._s(e.item+"x Speed"))])]}}])})],1),a("v-spacer"),a("v-flex",{staticClass:"shrink"},[a("v-switch",{staticClass:"px-2 flat",attrs:{label:"labels","hide-details":"","input-value":t.localShowLabels},on:{change:function(e){t.setShowLabels({labels:e})}}})],1),a("v-flex",{staticClass:"shrink"},[a("v-switch",{staticClass:"px-2 flat",attrs:{label:"shapes","hide-details":"","input-value":t.localShowShapes},on:{change:function(e){t.setShowShapes({shapes:e})}}})],1),a("v-flex",{staticClass:"shrink"},[a("v-select",{staticClass:"px-2",attrs:{items:Object.keys(t.colorByOptions).map(function(e){return t.colorByOptions[e]}),solo:"",value:t.colorByOptions[t.localColorBy]},on:{change:t.updateColorBy}})],1)],1)],1)},Gt=[],Kt=(a("7514"),{props:{colorByOptions:{type:Object,required:!0},playbackRateOptions:{type:Array,default:function(){return[.0625,.2,.5,1,2,5]}},withslider:{type:Boolean,default:!0}},data:function(){return{scrubbing:!1,time:0,localPlaybackRate:1,localColorBy:"",localDuration:0,localOffset:0,localShowLabels:!1,localShowShapes:!1,localPlaying:!1}},mounted:function(){var t=this;lt.$on("passive",function(e){return t.time=e}),this.$store.watch(function(e){t.setFromStore(e)})},methods:Object(w["a"])({},Object(K["c"])(["setPlaying","setPlaybackRate","setShowLabels","setShowShapes"]),Object(K["b"])(["groupByMeta"]),{setFromStore:function(t){this.localPlaybackRate=t.playbackRate,this.localColorBy=t.colorBy,this.localDuration=t.duration,this.localOffset=t.offset,this.localShowLabels=t.labels,this.localShowShapes=t.shapes,this.localPlaying=t.playing},pad:function(t){return t<10?"0".concat(t):t},toTimeStamp:function(t){var e=Math.floor(t/60),a=Math.floor(t%60);return"".concat(this.pad(e),":").concat(this.pad(a))},updateColorBy:function(t){var e=this;this.groupByMeta({key:x()(this.colorByOptions).find(function(a){return e.colorByOptions[a]===t})})},skip:function(t){t?lt.$emit("active",this.time+5):lt.$emit("active",this.time>5?this.time-5:0)}})}),Ut=Kt,qt=(a("6929"),Object(N["a"])(Ut,Ht,Gt,!1,null,null,null)),Yt=qt.exports,Xt={components:{TdmTable:at,VideoControls:Yt,VideoRegion:It},props:{autoplay:{type:Boolean,default:!0},loading:{type:Boolean,default:!1},labelFormat:{type:Array,default:function(){return[]}},colorBy:{type:String,default:""},meta:{type:Object,default:function(){}}},data:function(){return{width:0,loadingInternal:!1,twoColumn:!0,sidebarWidth:600}},beforeDestroy:function(){window.removeEventListener("resize",this.resize)},mounted:function(){this.resize(),window.addEventListener("resize",this.resize);var t=wt(window.location.hash.substring(1));"colorBy"in t&&this.colorByMeta({key:t.colorBy}),"select"in t&&this.setPreselect({preselect:t.select})},methods:Object(w["a"])({},Object(K["c"])(["colorByMeta","setPreselect"]),{handleTrackSelect:function(t){console.log(t)},resize:function(){var t=900,e=this.sidebarWidth,a=this.$refs.container.clientWidth;e+t<a?(this.width=a-e-30,this.twoColumn=!0):(this.width=a,this.twoColumn=!1)}})},Jt=Xt,Qt=Object(N["a"])(Jt,zt,Vt,!1,null,null,null),Zt=Qt.exports,te={components:{TdmApp:Zt,TdmTemporal:St,DivaKpfWidget:V,SelectionWidget:X},data:function(){return{loading:!1,initialColorBy:"name",labelFormat:["name","actor_id"],autocomplete:null,err:"",threshold:.8,meta:{name:"Activity Type",type:"Actor Type",actor_id:"Actor Id",origin:"Origin"},video:{url:"https://s3.amazonaws.com/diva-mturk-ingestion-prod/uuid-encoded/2018-12-12/00-05-00_00-10-00/G999_pilotsample/9c51f770-25c2-41bb-b244-cfea25bae3cd.mp4",width:1920,height:1080,framerate:30,duration:238.53,annotations:{activities:"".concat("/tdm/","data/activities.yml"),geom:"".concat("/tdm/","data/geom.yml"),types:"".concat("/tdm/","data/types.yml")}}}},computed:Object(K["d"])(["colorBy"]),mounted:function(){var t=Object(d["a"])(regeneratorRuntime.mark(function t(){var e,a,i,s,n,r,o,c,l;return regeneratorRuntime.wrap(function(t){while(1)switch(t.prev=t.next){case 0:if(this.setUrl({url:this.video.url}),this.setWidth({width:Lt()(this.video.width||1920,10)}),this.setHeight({height:Lt()(this.video.height||1080,10)}),this.setFramerate({framerate:b()(this.video.framerate||30)}),this.setDuration({duration:b()(this.video.duration||300)}),!("annotations"in this.video)){t.next=33;break}return e=this.video.annotations,this.err="",t.prev=8,this.loading=!0,t.next=12,Nt.a.get(e.activities);case 12:return a=t.sent,i=a.data,t.next=16,Nt.a.get(e.geom);case 16:return s=t.sent,n=s.data,t.next=20,Nt.a.get(e.types);case 20:r=t.sent,o=r.data,c=D.fromText(i,n,o),l=c.getTDM({origin:"S3"}),l.forEach(function(t){return t.shapes=I(t.detections)}),this.setTracks({tracks:l,key:this.initialColorBy}),this.loading=!1,t.next=33;break;case 29:t.prev=29,t.t0=t["catch"](8),this.err=t.t0.message,this.loading=!1;case 33:case"end":return t.stop()}},t,this,[[8,29]])}));function e(){return t.apply(this,arguments)}return e}(),methods:Object(w["a"])({},Object(K["c"])(["setUrl","setWidth","setHeight","setDuration","setFramerate","setColorBy","bucketSort","colorByMeta"]),Object(K["b"])(["addTracks","setTracks"]))},ee=te,ae=Object(N["a"])(ee,Mt,Rt,!1,null,null,null),ie=ae.exports;i["default"].use(K["a"]);var se={tracks:[],statemap:{},colormap:{},cache:{},colorBy:"",preselect:"",sortedTracks:{},url:"",width:1920,height:1080,framerate:30,duration:300,offset:0,playbackRate:1,labels:!0,shapes:!0,playing:!0},ne={activeContinuousFrames:function(t){return function(e){var a=[],i=Math.floor(e),s=Math.floor(i/Et)*Et;return t.tracks.forEach(function(e){var n=t.sortedTracks[e.key];if(!e.interpolated&&s in n){var r=n[s],o=r[0].frame,c=i-o;c>=0&&r.length>c&&a.push(r[c])}}),a}},activeKeyFrames:function(t){return function(e){var a=t.tracks.filter(function(t){return t.interpolated}).map(function(t){for(var a=t.detections,i=0;i<a.length-1;i+=1){var s=a[i],n=a[i+1];if(e>=s.frame&&e<=n.frame)return P(e,s,n)}return null}).filter(function(t){return null!==t});return a}}},re={bucketSort:function(t){t.sortedTracks={},t.tracks.forEach(function(e){if(!(e.key in t.sortedTracks)){var a={};e.detections.forEach(function(t){var e=Math.floor(t.frame/Et)*Et;e in a?a[e].push(t):a[e]=[t]}),x()(a).forEach(function(t){a[t]=a[t].sort(function(t,e){return t.frame-e.frame})}),t.sortedTracks[e.key]=a}})},colorByMeta:function(t,e){var a=e.key,i={},s={},n=0;t.tracks.forEach(function(t){var e=t.meta[a];if(e in i)t.color=i[e],s[e].push(t);else{var r=Ot[n%Ot.length];t.color=r,i[e]=r,s[e]=[t],n+=1}}),t.cache=s,t.colormap=i,t.colorBy=a},colorByBucketSequence:function(t,e){var a=e.key,i={};t.tracks.forEach(function(t){var e=t.meta[a]||-1,s=Math.floor(e/Pt.length),n=s>=0?Pt[s]:jt;i[e]=n,t.color=n}),t.colormap=i},resetState:function(t,e){var a=e.newstate,i={};t.tracks.forEach(function(e){e.state=a,i[e.meta[t.colorBy]]=a}),t.statemap=i},setColorBy:function(t,e){var a=e.colorBy;t.colorBy=a},setPreselect:function(t,e){var a=e.preselect;t.preselect=a},setTracks:function(t,e){var a=e.tracks;t.tracks=a},setUrl:function(t,e){var a=e.url;t.url=a},setWidth:function(t,e){var a=e.width;t.width=a},setHeight:function(t,e){var a=e.height;t.height=a},setDuration:function(t,e){var a=e.duration;t.duration=a},setFramerate:function(t,e){var a=e.framerate;t.framerate=a},setOffset:function(t,e){var a=e.offset;t.offset=a},setPlaybackRate:function(t,e){var a=e.playbackRate;t.playbackRate=a},setShowLabels:function(t,e){var a=e.labels;t.labels=a},setShowShapes:function(t,e){var a=e.shapes;t.shapes=a},setPlaying:function(t,e){var a=e.playing;t.playing=a},toggleByMeta:function(t,e){var a=e.value,i=e.newState,s=void 0===i?E.DISABLED:i,n=e.elseState,r=void 0===n?E.ACTIVE:n,o=e.xor,c=void 0!==o&&o,l=t.colorBy,h={};t.tracks.forEach(function(t){String(t.meta[l])===a?(t.state=s,h[t.meta[l]]=s):c?(t.state=r,h[t.meta[l]]=r):h[t.meta[l]]=t.state}),t.statemap=h}},oe={setTracks:function(t,e){var a=t.commit,i=e.tracks,s=e.key;a("setTracks",{tracks:i}),a("colorByMeta",{key:s}),a("bucketSort"),a("resetState",{newstate:E.ACTIVE})},addTracks:function(t,e){var a=t.state,i=t.commit,s=e.tracks,n=e.key;i("setTracks",{tracks:a.tracks.concat(s)}),i("colorByMeta",{key:n}),i("bucketSort"),i("resetState",{newstate:E.ACTIVE})},groupByMeta:function(t,e){var a=t.commit,i=e.key;a("colorByMeta",{key:i}),a("resetState",{newstate:E.ACTIVE})}},ce=new K["a"].Store({state:se,getters:ne,actions:oe,mutations:re});i["default"].use(Ft),new i["default"]({store:ce,render:function(t){return t(ie)}}).$mount("#app")}});
//# sourceMappingURL=app.4f62a4e9.js.map